set(PLUGIN_NAME node)

find_package(Boost 1.46 COMPONENTS filesystem system thread REQUIRED)
find_package(LibArchive REQUIRED)

if(NOT APPLE)
    option(COCAINE_ALLOW_CGROUPS "Build CGroups support for Process Isolate" ON)
else()
    option(COCAINE_ALLOW_CGROUPS "Build CGroups support for Process Isolate" OFF)
endif()

if(COCAINE_ALLOW_CGROUPS)
    locate_library(LibCGroup "libcgroup.h" "cgroup")

    set(LibCGroup_LIBRARY "cgroup")
    add_definitions(-DCOCAINE_ALLOW_CGROUPS=1)
else()
    message(STATUS "  Node service will be built without CGroups support")
endif()

include_directories(
    ${PROJECT_SOURCE_DIR}/node/include
)

add_library(${PLUGIN_NAME} SHARED
    src/isolate/process.cpp
    src/isolate/process/archive.cpp
    src/isolate/process/spooler.cpp
    src/module.cpp
    src/node.cpp
    src/node/app.cpp
    src/node/app/stats.cpp
    src/node/dispatch/client.cpp
    src/node/dispatch/worker.cpp
    src/node/error.cpp
    src/node/manifest.cpp
    src/node/overseer.cpp
    src/node/profile.cpp
    src/node/slave.cpp
    src/node/slave/channel.cpp
    src/node/slave/control.cpp
    src/node/slave/error.cpp
    src/node/slave/fetcher.cpp
    src/node/slave/state/active.cpp
    src/node/slave/state/handshaking.cpp
    src/node/slave/state/sealing.cpp
    src/node/slave/state/spawning.cpp
    src/node/slave/state/state.cpp
    src/node/slave/state/stopped.cpp
    src/node/slave/state/terminating.cpp
    src/stream
)

target_link_libraries(${PLUGIN_NAME}
    ${Boost_LIBRARIES}
    ${LibArchive_LIBRARIES}
    ${LibCGroup_LIBRARY}
    msgpack
    blackhole
    cocaine-core)

set(BUILD_FLAGS "-std=c++0x")
set(BUILD_FLAGS "${BUILD_FLAGS} -Wall")
set(BUILD_FLAGS "${BUILD_FLAGS} -Wextra")
set(BUILD_FLAGS "${BUILD_FLAGS} -Waddress")
set(BUILD_FLAGS "${BUILD_FLAGS} -Warray-bounds")
set(BUILD_FLAGS "${BUILD_FLAGS} -Wbuiltin-macro-redefined")
set(BUILD_FLAGS "${BUILD_FLAGS} -Wctor-dtor-privacy")
set(BUILD_FLAGS "${BUILD_FLAGS} -Winit-self")
set(BUILD_FLAGS "${BUILD_FLAGS} -Wnon-virtual-dtor")
set(BUILD_FLAGS "${BUILD_FLAGS} -Wold-style-cast")
set(BUILD_FLAGS "${BUILD_FLAGS} -Woverloaded-virtual")
set(BUILD_FLAGS "${BUILD_FLAGS} -Wswitch")
set(BUILD_FLAGS "${BUILD_FLAGS} -Wunreachable-code")
set(BUILD_FLAGS "${BUILD_FLAGS} -pedantic -pedantic-errors")

set_target_properties(${PLUGIN_NAME} PROPERTIES
    COMPILE_FLAGS "${BUILD_FLAGS}"
    PREFIX ""
    SUFFIX "${COCAINE_PLUGIN_SUFFIX}"
)

install(TARGETS ${PLUGIN_NAME}
    LIBRARY DESTINATION lib/cocaine
    COMPONENT runtime)

install(
    DIRECTORY
        include/cocaine/api
        include/cocaine/idl
        include/cocaine/service
    DESTINATION include/cocaine
    COMPONENT development)
